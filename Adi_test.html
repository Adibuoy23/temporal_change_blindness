<!DOCTYPE html>
<html>

<head>
  <script src="./jspsych/dist/jspsych.js"></script>
  <script src="./plugin-html-button-response.js"></script>
  <script src="./jspsych/dist/plugin-html-keyboard-response.js"></script>
  <script src="./jspsych/dist/plugin-video-keyboard-response.js"></script>
  <script src="./plugin-cb-video.js"></script>
  <script src="./jspsych/dist/plugin-preload.js"></script>
  <script src="./jspsych/dist/plugin-fullscreen.js"></script>
  <script src="./input.js"></script>
  <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="./jspsych/dist/jspsych.css">
</head>

<body>
</body>

<script>
  var jsPsych = initJsPsych({
    override_safe_mode:true,
    use_web_audio:true,
    on_finish: function() {
    jsPsych.data.displayData();
    document.body.style.cursor = 'default';
  }
  });

  /* create timeline */
  var timeline = [];

  var test_stimuli = stimuli.slice(0,1);
  stimuli = stimuli.slice(1,stimuli.length);

 var test_videos = [
   test_stimuli.map(a => a.video_one),
   test_stimuli.map(a => a.video_two),
   test_stimuli.map(a => a.video_three)
 ]

  var videos = [
    stimuli.map(a => a.video_one),
    stimuli.map(a => a.video_two),
    stimuli.map(a => a.video_three)
  ]

  /* preload images */
  var preload = {
    type: jsPsychPreload,
    video: test_videos,
  };
  timeline.push(preload);

  var fullscreen_start = {
    type: jsPsychFullscreen,
    fullscreen_mode: true
  };
  timeline.push(fullscreen_start);


  var start = {
    type: jsPsychHtmlButtonResponse,
    stimulus: '<h3>Welcome to the experiment!</h3><p>Your goal in this experiment is to <b>detect temporal shifts in video.</b></p>',
    choices: ['Next']
  };

  timeline.push(start);

  var introduction = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>You will be watching movie clips without audio (1 min long) from the movie 1917." +
               "<br> "+
               "<br>1917 was released in 2019 - This movie is famous for its single long shot cinematography with no scene cuts." +
               "<br> "+
               "<br>This means that visually the movie watching experience should be smooth and continuous without any disruptions." +
               "<br> "+
               "<br>However, for the purposes of this study, we have added some disruptions to the movie clips you are going to be watching today." +
               "<br> "+
               "<br>These disruptions are abrupt flickers in the video. You will find the <strong>screen to flicker periodically</strong> when watching these clips. </p>",
    choices: ["Next"]
  };
  timeline.push(introduction);

  var introduction2 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p>Occasionally during these screen flickers, the video clips jump forward / backward in time" +
               "<br> "+
               "<br>Your job is to detect the video jumps in time and report them" +
               "<br> "+
               "<br>You will report them by pressing the <strong>SPACE BAR</strong> immediately as soon as you noticed the jumps" +
               "<br> "+
               "<br>Try to be as quick as possible in reporting these jumps. </p>",
    choices: ["Next"]
  };
  timeline.push(introduction2);


  var introduction3 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> Get ready... Here we go!!! <br> <strong>For Science!</strong> </p>",
    choices: ["Whatever dude! I need credits", "Let's do it!"]
  };
  timeline.push(introduction3);

  var introduction4 = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> LOL;JK!!! Seriously though, this should take not more than 30 minutes of your time</p>",
    choices: ["Okay, now show me a demo trial"]
  };
  timeline.push(introduction4);

  var fixation = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<div class="container-debug">' +
              '<div style="font-size:60px;color:black;text-align:center;vertical-align:middle;line-height:375px;">+</div>' +
              '</div>',
    choices: 'NO_KEYS',
    trial_duration: 1000,
    on_start: function(trial) {
      document.body.style.cursor = 'none';
      }
  }

  var demo_trial = {
    type: jsPsychCbVideo,
    response_allowed_while_playing:true,
    width:1000,
    stimulus:[test_stimuli[0].video_one, test_stimuli[0].video_two, test_stimuli[0].video_three],
    flicker_duration: 80,
    flicker_frequency: 2000,
    choices: ' ',
    trial_ends_after_video:true,
    prompt: "Press SPACEBAR when you see the video jump in time.",
    response_ends_trial:false,
    show_feedback:true,
  };

  timeline.push({
    timeline: [fixation, demo_trial],
    timeline_variables: test_stimuli
              });

  var revisit_demo = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> Do you want to try the demo again to understand the experiment?</p>",
    choices: ["Yes", "No, I think I got it"],
  };

  var if_revisit_demo = {
    timeline : [fixation, demo_trial, revisit_demo],
    conditional_function: function(){
      //get the data from the previous trial
      // and check which button was pressed
      console.log(jsPsych.data.get().last(1).values()[0]);
      var data = jsPsych.data.get().last(1).values()[0];
      if (data.response ==0){
        return true;
      } else {
        return false;
      }
    }
  }
  timeline.push({
    timeline: [revisit_demo, if_revisit_demo, if_revisit_demo],
  });


  /* preload images */
  var preload2 = {
    type: jsPsychPreload,
    video: videos,
    message: "Preloading the rest of the experiment. This might take a while.",
  };
  timeline.push(preload2);

  var no_feedback_notification = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "<p> Unlike the demo the rest of the experiment will not have any feedback </p>",
    choices: ["Understood"],
  };
  timeline.push(no_feedback_notification);


  var trial = {
    type: jsPsychCbVideo,
    response_allowed_while_playing:true,
    width:1000,
    stimulus:[jsPsych.timelineVariable('video_one'), jsPsych.timelineVariable('video_two'), jsPsych.timelineVariable('video_three')],
    flicker_duration: 150,
    flicker_frequency: 2000,
    choices: ' ',
    trial_ends_after_video:true,
    prompt: " ",
    response_ends_trial:false,
    show_feedback:false
  };

  timeline.push({
    timeline: [fixation, trial],
    timeline_variables: stimuli
              });

  var fullscreen_trial_exit = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
  };

  timeline.push(fullscreen_trial_exit);

  if (typeof jsPsych !== "undefined") {
    jsPsych.run(timeline);
  } else {
    document.body.innerHTML = '<div style="text-align:center; margin-top:50%; transform:translate(0,-50%);">You must be online to view the demo.</div>';
  }
</script>

</html>
